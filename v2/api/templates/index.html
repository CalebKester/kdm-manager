<!doctype html>
<html ng-app="theWatcher" ng-controller="globalController">
 <title>http://thewatcher.io - The Watcher - {{ settings.application.title }}</title>
 <head>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-71038485-2', 'auto');
      ga('send', 'pageview');
    </script>

    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.3/angular.min.js"></script>
    <script src="http://code.angularjs.org/1.5.3/angular-route.min.js"></script>
    <script src="/static/js/app.js"></script>
    <link rel="stylesheet" href="/static/css/style.css" />
 </head>


 <body>

    <h1>{{ settings.application.app_name }}</h1>
    <h2>{{ settings.application.title }}</h2>
    <h3> API Version {{ settings.api.version }}</h3>

    <table class="api_documentation">
        <tr><th colspan="3">API Documentation!</th></tr>
        <tr><td colspan="3">

        <p>The KDM API at <a href="http://api.thewatcher.io">http://api.thewatcher.io</a>
        is a RESTful API for campaign/settlement management in "Monster" by
        <a href="http://kingdomdeath.com" target="top">Kingdom Death</a>.</p>
        <p>The API is a fan-created and fan-maintained project that is not
        supported by, affiliated with or otherwise authorized by Kingdom Death.</p>
        <p>
            <a href="https://github.com/toconnell/kdm-manager" target="top">GitHub</a> |
            <a href="https://twitter.com/thewatcherapp" target="top">Twitter</a> |
            <a href="http://kdm-manager.blogspot.com/" target="top">Development blog</a>
        </p>

    </table>

    <table class="api_documentation public_routes">

        </td></tr>
        <tr><th colspan="3">PUBLIC ROUTES</th></tr>
        <tr>
            <td colspan="3">
                <p>
                    These routes <b>DO NOT</b> require authentication. Use them
                    to construct dashboard, "create new whatever" type views and
                    to look up game asset data that does not belong to any user.
                </p>
            </td>
        </tr>

        <tr class="ul">
            <th class="route">Route</th><th class="methods">Methods</th><th class="comment">Comment/Note</th>
        </tr>


        <tr class="ul">
            <td> <a href="/campaign">/campaign</a> </td>
            <td> POST </td>
            <td>
                <p>Accepts a "name" or "handle" parameter included in the body
                of the request (which should be JSON) and returns a JSON
                representation of the campaign:</p>
                <code>{"name": "People of the Lantern"}</code>
                <p>...gets you something like this:</p>
                <code>{"handle": "people_of_the_lantern","milestones":
                ["first_child", "first_death", "pop_15", "innovations_5",
                "game_over" ], "saviors": "1.3.1", "name": "People of the Lantern",
                "default": true, "principles": ["new_life", "death", "society",
                "conviction"], "always_available": { "location": ["Lantern
                Hoard"], "innovation": ["Language"]},"nemesis_monsters": [
                "butcher", "kings_man","the_hand","watcher"],"quarries": [
                "white_lion","screaming_antelope","phoenix", "beast_of_sorrow",
                "great_golden_cat", "mad_steed", "golden_eyed_king"],"type":
                "campaign_definition"}</code>
                <p>NB: this also works with handles, e.g.:</p>
                <code>{"handle": "people_of_the_stars"}</code>
            </td>
        </tr>

        <tr class="ul">
            <td> <a href="/login">/login</a> </td>
            <td> POST </td>
            <td>
                <p>        
                    The KD:M API uses JSON Web Tokens (<a
                    href="https://jwt.io/">https://jwt.io</a>) to manage user
                    sessions and user authentication.
                </p>
                <p> POST to this route with JSON containing user credentials in
                the body of the request to get a token:</p>
                <code>Authorization: {"username": "demo@kdm-manager.com", "password": 
                "l33th4x0r"}</code>
                <p>...if your credential checks out, you get a token and the the
                the user's ID (see below for working with users) back. Easy!</p>
            </td>
        </tr>

        <tr class="ul">
            <td> <a href="/monster">/monster</a> </td>
            <td> POST </td>
            <td>
                <p>
                    Accepts a "name" or "handle" parameter (via JSON) and
                    returns a JSON representation of a monster type game asset.
                    For example, POSTing to /monster with JSON such as this:
                </p>
                <code>{"name": "White Lion Lvl. 1"}</code>
                <p>...returns JSON like this: </p>
                <code>{"comment": "Lvl. 1", "handle": "white_lion", "name":
                "White Lion", "level": 1, "levels": 3, "sort_order": 0, "type":
                "quarry"}
                <p>Or, with a handle:</p>
                <code>{"handle": "manhunter"}</code>
                <p>...you get:</p>
                <code>{"handle": "manhunter", "name": "Manhunter", "levels": 4,
                "sort_order": 103, "type": "nemesis", "selectable": false, 
                "misspellings": ["THE MANHUNTER", "MAN HUNTER"]}
                </code>
            </td>
        </tr>
        <tr class="ul">
            <td> <a href="/new_settlement">/new_settlement</a></td>
            <td> GET </td>
            <td> Returns JSON representing available options for creating a new
            settlement, including expansions, pre-fab survivors, etc. Also
            includes subtitle/description elements. Use this to make "create
            new settlement" type views. </td>
        </tr>
        <tr class="ul">
            <td> <a href="/settings.json">/settings.json</a> </td>
            <td> GET</td>
            <td> Not strictly a part of the API, but sometimes useful. Hit this
            route to download an attachement of settings.cfg as JSON. </td>
        </tr>
        <tr class="ul">
            <td> <a href="/settings">/settings</a> </td>
            <td> GET </td>
            <td> Retrieve settings.cfg as JSON</td>
        </tr>
        <tr class="ul">
            <td> <a href="/world">/world</a> </td>
            <td> GET </td>
            <td> Retrieve a JSON representation of aggregate/world stats.</td>
        </tr>
    </table>


    <table class="api_documentation private_routes">
        <tr><th colspan="3">PRIVATE ROUTES</th></tr>
        <tr>
            <td colspan="3">
                <p>Private routes require an Authorization header including a
                JWT token.</p>
                <p>(See the documentation above for more info on how to POST
                user credentials to the <code>/login</code> route to get a
                token.)</p>
                <p>Generally speaking, when you access any private route, you 
                want your headers to look like this when using private routes:
                </p>
                <code>
                {
                    'content-type': 'application/json',
                    'Authorization': 'eyJhbGciOiJIUzI1NiIsInR5cCI6...'
                }
                </code>
                <p>Finally, keep in mind that tokens are extremely short-lived,
                so you should be prepared to refresh them frequently. See the
                section below on 'Authorization Token Management' for more info
                on checking/refreshing tokens.</p>
            </td>
        </tr>

        <tr class="ul">
            <th class="route">Route</th><th class="methods">Methods</th><th class="comment">Comment/Note</th>
        </tr>


        <tr class="ul route_root">
            <th colspan="3"><b>Authorization Token Management:</b> once you've
            got an authorization token, you can work with it using these
            routes. Most failures from these routes are reported back as
            401's, since they concern authorization. </th>
        </tr>
        <tr class="ul">
            <td> /authorization/check</td>
            <td> GET,POST </td>
            <td> 
            GET or POST to this endpoint to determine if your Authorization header
            is still valid or if it has expired.
            </td>
        </tr>
        <tr class="ul">
            <td> /authorization/refresh</td>
            <td> POST </td>
            <td> 
            <p> Use the standard 'Authorization' header and POST an empty request to
            this route to recieve a new Auth token based on the previous one.</p>
            <p> On the back end, this route reads the incoming 'Authorization'
            header and, even if the JWT token is expired, will check the 'login'
            and 'password' (hash) keys: if they check out, you get a 200 and a
            brand new token.</p>
            <p> Finally, the KDM API does NOT use refresh tokens (it just feels 
            like overkill, you know?).</p>
            </td>
        </tr>


        <tr class="ul route_root">
            <th colspan="3"><b>Create Assets:</b> To create new assets (survivor, settlement),
            POST JSON containing appropriate params to the /new/&lt;asset_type&gt;
            route. Invalid or unrecognized params will be ignored!</th>
        </tr>
        <tr class="ul">
            <td> /new/settlement </td>
            <td> POST </td>
            <td> <p>Use 'handle' values from the <code>/new_settlement</code>
            route (see above) as params, like this:</p>
            <code> {"campaign": "people_of_the_lantern", "expansions": ["dung_beetle_knight",
            "lion_god"], "survivors": ["adam", "anna"], "name": "Chicago",
            "special": ["create_first_story_survivors"]}
            </code>
            <p><b>NB:</b> if successful, this route returns a serialized version of the new settlement,
            including its OID, as JSON.</p>
            </td>
        </tr>
        <tr class="ul">
            <td> /new/survivor </td>
            <td> POST </td>
            <td> Coming Soon!</td>
        </tr>



        <tr class="ul route_root">
            <th colspan="3"><b>User Routes:</b> all routes for working directly with a user follow a <code>/user/&lt;action&gt;/&lt;settlement_id&gt;</code> convention. These routes are private and require authentication.</th>
        </tr>
        <tr class="ul">
            <td> /user/get/&lt;user_id&gt; </td>
            <td> GET </td>
            <td> Retrieve a serialized version of the user who owns &lt;user_id&gt;,
            to include some additional usage and meta facts about that user. </td>
        </tr>
        <tr class="ul">
            <td> /user/set/&lt;user_id&gt; </td>
            <td> POST, OPTIONS </td>
            <td> <p>This route supports the assignment of user-specified key/value
            attributes to the user object.</p><p>To set an attribute, include
            JSON in the body of the request that indicates the key/value to set.</p>
            Supported attribute keys include:
                <table class="embedded_table">
                    <tr><th>key</th><th>value</th></tr>
                    <tr><td class="key">current_settlement</td><td class="value">
                    OID of an existing,non-removed settlement.</td></tr>
                </table>
            Use multiple key/value pairs to set multiple attributes in a single
            request, e.g. <code>{"current_settlement": $oid, "current_session":
            $oid}</code>
            </p>
            <p><b>Important!</b> This route does not support the assignment of
            arbitrary keys and will completely fail any request that includes
            unsupported keys!</p>
            </td>
        </tr>


        <tr class="ul route_root">
            <th colspan="3"><b>Settlement Routes:</b> all routes for working directly with a settlement follow a <code>/settlement/&lt;action&gt;/&lt;settlement_id&gt;</code> convention. These routes are private and require authentication. </th>
        </tr>
 

        <!-- settlement GET -->

       <tr class="ul">
            <td> /settlement/get/&lt;settlement_id&gt; </td>
            <td> GET </td>
            <td> Retrieve a serialized version of the settlement associated with
            &lt;settlement_id&gt; (to include all related user and game assets, including survivors).</td>
        </tr>
        <tr class="ul">
            <td> /settlement/get_event_log/&lt;settlement_id&gt; </td>
            <td> GET </td>
            <td> Retrieve all settlement event log entries (in a giant hunk of JSON).</td>
        </tr>
        <tr class="ul">
            <td> /settlement/get_innovation_deck/&lt;settlement_id&gt; </td>
            <td> GET </td>
            <td> Retrieve the settlement's current innovation deck (as an array).</td>
        </tr>


        <!-- settlement update -->

        <tr class="ul">
            <td> /settlement/set/&lt;settlement_id&gt; </td>
            <td> POST </td>
            <td> Not implemented! Coming soon!</td>
        </tr>
        <tr class="ul">
            <td> /settlement/add_expansions/&lt;settlement_id&gt; </td>
            <td> POST </td>
            <td> Add expansions to a settlement by POSTing a list of expansion
            handles. The body of your post should be a JSON-style list: 
            <code>['beta_challenge_scenarios','dragon_king']</code>
            <p>
            Note that this route not only updates the settlement sheet, but also
            adds/removes timeline events, updates the settlement's available game
            assets (e.g. items, locations, etc.).
            </p>
            </td>
        </tr>
        <tr class="ul">
            <td> /settlement/rm_expansions/&lt;settlement_id&gt; </td>
            <td> POST </td>
            <td> Remove expansions from a settlement by POSTing a list of
            expansion handles. The body of your post should be a JSON-style 
            list: 
            <code>['manhunter','gorm','spidicules']</code>
            <p>
            Note that this route not only updates the settlement sheet, but also
            adds/removes timeline events, updates the settlement's available game
            assets (e.g. items, locations, etc.).
            </p>
            <p><b>Important!</b> We're all adults here, and the KDM API will
            <i>not</i> stop you from removing expansion handles for expansions
            that are required by your settlement's campaign. If you want to
            prevent users from doing this, that's got to be part of your UI/UX
            considerations.</p>
            </td>
        </tr>
        <tr class="ul">
            <td> /settlement/set_current_quarry/&lt;settlement_id&gt; </td>
            <td> POST </td>
            <td> <p>This route sets the settlement's 'current_quarry' attribute,
            which is the monster that the settlement's Departing Survivors are
            currently hunting.</p><p>POST some simple JSON containing a monster
            name (do not use handles for this):</p>
            <code>{'current_quarry': 'White Lion Lvl 2'}</code>
            <p>...or, the monster is unique:</p>
            <code>{'current_quarry': 'Watcher'}</code>
            <p><b>Important!</b> You're typically going to want to pull monster
            names from the settlements' <code>game_assets -> defeated_monsters</code>
            list (which is a list of monster names created for the settlement
            based on expansion content, etc.)</p>
            </td>
        </tr>
        <tr class="ul">
            <td> /settlement/add_timeline_event/&lt;settlement_id&gt; </td>
            <td> POST </td>
            <td> <p>Adding a timeline event to a settlement's timeline requires a
            fairly specific bit of JSON. To add, for example, a settlement event,
            you need to post JSON that looks like this:</p>
            <code>{'type': 'settlement_event', 'ly': 3, 'handle': 'core_haunted',
            'name': 'Haunted', 'user_login': 'dev@kdm-manager.com'}</code>
            <p>Event names, types, handles, etc. can be found in the settlement's
            <code>game_assets -> events</code> (which is a dictionary of
            settlement and story events).</p>
            <p>Adding showdown type events works similarly:<p>
            <code>{'type': 'showdown_event', 'name': 'White Lion Lvl 1', 
            'ly': 4, 'user_login': 'user@whatever.com'}</code>
            <p>...or, for a special showdown:</p>
            <code>{'type': 'special_showdown', 'name': 'Watcher', 'ly': 20,
            'user_login': 'qa@kdm-manager.com'}</code>
            <p>Here is a list of accepted event 'type' values: 
            <ul>
                <li><code>showdown_event</code></li>
                <li><code>special_showdown</code></li>
                <li><code>nemesis_encounter</code></li>
                <li><code>settlement_event</code></li>
                <li><code>story_event</code></li>
            </ul>
            <b>Important!</b> Events without handles may be added, which means
            that you may absolutely add an event that <i>does not</i> come from
            the settlement's <code>game_assets -> events</code>. Events with
            neither a name nor a handle may not be added, however.
            </p>
            </td>
        </tr>
        <tr class="ul">
            <td> /settlement/rm_timeline_event/&lt;settlement_id&gt; </td>
            <td> POST </td>
            <td> <p>Works just like the <code>add_timeline_event</code> method,
            except in reverse. POST some JSON describing a timeline event
            that exists on the settlement's timeline to remove it:</p>
            <code>{'type': 'settlement_event', 'ly': 3, 'handle': 'core_haunted',
            'name': 'Haunted', 'user_login': 'dev@kdm-manager.com'}</code>
            <p>Since the <code>add_timeline_event</code> method allows for events
            without <code>handle</code> attributes (i.e. since it will accept
            JSON with a <code>name</code> and no <code>handle</code>), events
            may be removed using only their name and Lantern Year (<code>'ly'
            </code>) attribute:</p>
            <code>{'type': 'nemesis_encounter', 'name': 'Butcher Lvl 1', 'ly': 4,
            'user_login': 'user@whatever.com'}</code>
            </td>
        </tr>
        <tr class="ul">
            <td> /settlement/add_innovation/&lt;settlement_id&gt; </td>
            <td> POST </td>
            <td> <p> POST an Innovation <code>handle</code> to this route to add
            it to the settlement's Innovations:</p>
            <code>{'handle': 'hovel'}</code>
            <p>...or:</p><code>{'handle': 'mastery_club'}</code>
            <p>Innovation handles may be found in the settlement's
            <code>game_assets -> innovations</code> element, which is a
            dictionary/hash of innovations where the keys are handles.</p>
            </td>
        </tr>
        <tr class="ul">
            <td> /settlement/rm_innovation/&lt;settlement_id&gt; </td>
            <td> POST </td>
            <td> <p>This is basically the reverse of <code>add_innovation</code>
            and works nearly identically. POST a JSON representation of an 
            Innovation handle to remove it from the settlement's list:</p>
            <code>{'handle': 'mastery_club'}</code>
            </td>
        </tr>
        <tr class="ul">
            <td> /settlement/set_innovation_level/&lt;settlement_id&gt; </td>
            <td> POST </td>
            <td> <p>For Innovations that have a level (e.g. the Slenderman's 'Dark
            Water Research'), you may set the Innovation's level by posting
            the <code>handle</code> of the innovation and the level:</p>
            <code>{'handle': 'dark_water_research', 'level': 2}</code>
            </td>
        </tr>


        <!-- meta updates, e.g. logs, notes, etc. -->
        <tr class="ul">
            <td> /settlement/add_settlement_note/&lt;settlement_id&gt; </td>
            <td> POST </td>
            <td> Documentation coming soon! </td>
        </tr>
        <tr class="ul">
            <td> /settlement/rm_settlement_note/&lt;settlement_id&gt; </td>
            <td> POST </td>
            <td> Documentation coming soon! </td>
        </tr>



        <tr class="ul route_root">
            <th colspan="3"><b>Survivor Routes:</b> all routes for working directly with an individual survivor follow a <code>/settlement/&lt;action&gt;/&lt;settlement_id&gt;</code> convention. Like settlement routes, these routes are private and require authentication. </th>
        </tr>

        <tr class="ul">
            <td> /settlement/get/&lt;survivor_id&gt; </td>
            <td> GET </td>
            <td> Retrieve a serialized version of the survivor.</td>
        </tr>

    </table>


 </body>
</html>
